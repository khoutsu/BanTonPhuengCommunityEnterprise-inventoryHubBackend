# Environment Configuration Guide

## JWT Authentication Setup

To enable JWT authentication alongside Firebase Auth, you need to configure the following environment variables in your `.env` file:

### Required JWT Environment Variables

```bash
# JWT Configuration
JWT_SECRET=your-super-secret-jwt-key-here
JWT_REFRESH_SECRET=your-super-secret-jwt-refresh-key-here
JWT_ACCESS_TOKEN_EXPIRY=15m
JWT_REFRESH_TOKEN_EXPIRY=7d
```

### JWT Configuration Details

#### JWT_SECRET
- **Purpose**: Used to sign and verify JWT access tokens
- **Requirements**: Should be a long, random, cryptographically secure string
- **Recommended**: At least 256 bits (32 characters) of random data
- **Example**: Use `node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"` to generate

#### JWT_REFRESH_SECRET
- **Purpose**: Used to sign and verify JWT refresh tokens
- **Requirements**: Should be different from JWT_SECRET and equally secure
- **Recommended**: At least 256 bits (32 characters) of random data
- **Security**: Keep this completely separate from access token secret

#### JWT_ACCESS_TOKEN_EXPIRY
- **Purpose**: Sets how long access tokens remain valid
- **Format**: Time string (e.g., '15m', '1h', '2d')
- **Recommended**: 15 minutes to 1 hour for security
- **Balance**: Shorter = more secure, but more frequent refreshes needed

#### JWT_REFRESH_TOKEN_EXPIRY
- **Purpose**: Sets how long refresh tokens remain valid
- **Format**: Time string (e.g., '7d', '30d', '90d')
- **Recommended**: 7-30 days depending on security requirements
- **Note**: Users must re-login when refresh token expires

### Security Best Practices

1. **Never commit secrets to version control**
   - Use `.env` file (included in `.gitignore`)
   - Use different secrets for development/production

2. **Generate strong secrets**
   ```bash
   # Generate JWT_SECRET
   node -e "console.log('JWT_SECRET=' + require('crypto').randomBytes(32).toString('hex'))"
   
   # Generate JWT_REFRESH_SECRET
   node -e "console.log('JWT_REFRESH_SECRET=' + require('crypto').randomBytes(32).toString('hex'))"
   ```

3. **Use environment-specific secrets**
   - Development: Can use simpler secrets for testing
   - Production: Must use cryptographically secure random secrets

4. **Regular secret rotation**
   - Rotate secrets periodically (every 3-6 months)
   - Have a secret rotation strategy in place

### Environment Setup Steps

1. **Copy the example file**:
   ```bash
   cp .env.example .env
   ```

2. **Generate JWT secrets**:
   ```bash
   # Run these commands and copy the output to your .env file
   node -e "console.log('JWT_SECRET=' + require('crypto').randomBytes(32).toString('hex'))"
   node -e "console.log('JWT_REFRESH_SECRET=' + require('crypto').randomBytes(32).toString('hex'))"
   ```

3. **Update your .env file** with the generated secrets

4. **Verify configuration** by starting the server and checking logs

### Token Expiry Configuration Options

#### Access Token Expiry Options:
- `5m` - 5 minutes (very secure, frequent refreshes)
- `15m` - 15 minutes (recommended for high security)
- `1h` - 1 hour (balanced security/usability)
- `4h` - 4 hours (longer sessions, less secure)

#### Refresh Token Expiry Options:
- `1d` - 1 day (very short, frequent re-logins)
- `7d` - 7 days (recommended for most apps)
- `30d` - 30 days (longer sessions)
- `90d` - 90 days (enterprise apps with SSO)

### Authentication Flow

With JWT authentication enabled, your app supports dual authentication:

1. **Firebase ID Tokens** (existing):
   - Generated by Firebase Auth
   - Verified using Firebase Admin SDK
   - User data from Firestore

2. **Custom JWT Tokens** (new):
   - Generated by your backend
   - Verified using your JWT secrets
   - User data from Firestore
   - Supports access/refresh token pattern

### API Endpoints

Once configured, these JWT endpoints become available:

- `POST /api/jwt-auth/register` - Register with JWT tokens
- `POST /api/jwt-auth/login` - Login with JWT tokens
- `POST /api/jwt-auth/refresh` - Refresh access token
- `POST /api/jwt-auth/logout` - Logout and revoke tokens
- `POST /api/jwt-auth/logout-all` - Logout from all devices
- `GET /api/jwt-auth/profile` - Get user profile

### Testing Configuration

You can test if JWT configuration is working:

1. Start the server: `npm start`
2. Check for JWT-related logs in console
3. Test registration: `POST /api/jwt-auth/register`
4. Verify token generation and validation

### Troubleshooting

#### Common Issues:

1. **"JWT secret not configured"**
   - Check `.env` file exists and has JWT_SECRET
   - Restart server after changing .env

2. **"Token verification failed"**
   - Ensure JWT_SECRET matches between token creation and verification
   - Check token hasn't expired

3. **"Refresh token invalid"**
   - Ensure JWT_REFRESH_SECRET is set correctly
   - Check refresh token hasn't expired
   - Verify refresh token exists in database

#### Debug Mode:
Add this to your .env for detailed JWT logs:
```bash
DEBUG=jwt:*
```

### Production Deployment

For production environments:

1. Use strong, unique secrets (at least 32 bytes)
2. Set shorter access token expiry (5-15 minutes)
3. Configure proper CORS for your domain
4. Enable HTTPS only
5. Set secure cookie flags if using cookies
6. Implement rate limiting on auth endpoints
7. Monitor for unusual authentication patterns

### Migration from Firebase-only Auth

If migrating from Firebase-only authentication:

1. Keep existing Firebase Auth working
2. Add JWT environment variables
3. Deploy updated backend
4. Gradually migrate frontend to use JWT endpoints
5. Both auth methods work simultaneously
6. No user data migration required (same Firestore collections)